services:
  mosquitto:
    image: ghcr.io/${GHCR_OWNER}/heatpump-mqtt:latest
    container_name: heatpump-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    environment:
      - MQTT_USER=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
    volumes:
      - mqtt_data:/mosquitto/data
      - mqtt_log:/mosquitto/log
    networks:
      - heatpump

  influxdb:
    image: influxdb:2.7-alpine
    container_name: heatpump-influxdb
    restart: unless-stopped
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}
      - DOCKER_INFLUXDB_INIT_RETENTION=${INFLUXDB_RETENTION}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN}
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - heatpump
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    image: ghcr.io/${GHCR_OWNER}/heatpump-backend:latest
    container_name: heatpump-backend
    restart: unless-stopped
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET}
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
    depends_on:
      influxdb:
        condition: service_healthy
      mosquitto:
        condition: service_started
    networks:
      - heatpump
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  dashboard:
    image: ghcr.io/${GHCR_OWNER}/heatpump-dashboard:latest
    container_name: heatpump-dashboard
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - heatpump

networks:
  heatpump:
    driver: bridge

volumes:
  mqtt_data:
  mqtt_log:
  influxdb_data:
  influxdb_config:
