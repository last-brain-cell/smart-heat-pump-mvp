services:
  # ===========================================
  # MQTT Broker - Mosquitto
  # ===========================================
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: heatpump-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"   # MQTT
      - "9001:9001"   # WebSocket (for web dashboard)
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - heatpump-network

  # ===========================================
  # Database - InfluxDB 2.x (Time-Series)
  # ===========================================
  influxdb:
    image: influxdb:2.7-alpine
    container_name: heatpump-influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_USER:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD:-heatpump123}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-heatpump}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET:-sensor_data}
      - DOCKER_INFLUXDB_INIT_RETENTION=${INFLUXDB_RETENTION:-30d}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN:-heatpump-super-secret-token}
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - heatpump-network
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Backend API - Python FastAPI
  # ===========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: heatpump-backend
    restart: unless-stopped
    environment:
      # InfluxDB Configuration
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-heatpump-super-secret-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-heatpump}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-sensor_data}
      # MQTT Configuration
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER:-heatpump}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-heatpump123}
    ports:
      - "8000:8000"
    depends_on:
      influxdb:
        condition: service_healthy
      mosquitto:
        condition: service_started
    networks:
      - heatpump-network
    volumes:
      - ./backend:/app

  # ===========================================
  # Web Dashboard - Nginx serving static files
  # ===========================================
  dashboard:
    image: nginx:alpine
    container_name: heatpump-dashboard
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
    networks:
      - heatpump-network

networks:
  heatpump-network:
    driver: bridge

volumes:
  influxdb_data:
  influxdb_config:
